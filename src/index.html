<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <style>

    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      width: 960px;
      height: 500px;
      position: relative;
    }
    path {
      fill: red;
      stroke: black;
    }

  </style>
  <!--
    <script src="http://d3js.org/d3.v3.min.js"></script>
  -->
</head>
<body>

<script type="text/vnd.graphviz" id="cluster">
digraph G {

	subgraph cluster_0 {
		style=filled;
		color=lightgrey;
		node [style=filled,color=white];
		a0 -> a1 -> a2 -> a3;
		label = "process #1";
	}

	subgraph cluster_1 {
		node [style=filled];
		b0 -> b1 -> b2 -> b3;
		label = "process #2";
		color=blue
	}
	start -> a0;
	start -> b0;
	a1 -> b3;
	b2 -> a3;
	a3 -> a0;
	a3 -> end;
	b3 -> end;

	start [shape=Mdiamond];
	end [shape=Msquare];
}

</script>

<script src="require.js"></script>
<script>
  require.config({
    paths: {
      d3: 'http://d3js.org/d3.v3.min'
    },
    shim: {
      d3: {
        exports: 'd3'
      }
    }
  });
  require(["main", "jsdump", "d3"],
      function (tool, dump, d3) {
        var width = 218,
            height = 400,
            dot = document.getElementById('cluster').innerHTML;

        var line = d3.svg.line()
            .x(function (d) {
              return d[0];
            })
            .y(function (d) {
              return d[1];
            })
            .interpolate("bundle");

        var drawer = {
          polygon: function (selection) {
            selection
                .attr("d", function (d) {
                  return [
                    "M",
                    d.points[0].join(','),
                    "L",
                    d.points.slice(1, d.points.length).map(function (e) {
                      return e.join(",")
                    }),
                    "Z"
                  ].join(" ");
                });
          },
          ellipse: function (selection) {
            selection
                .attr("d", function(d) {
                  return [
                      'M',
                      [d.cx,d.cy].join(','),
                      'm',
                      [-d.rx,0].join(','),
                      'a',
                      [d.rx,d.ry].join(','),
                      0, "1,0",
                      [2*d.rx,0].join(','),
                      'a',
                      [d.rx,d.ry].join(','),
                      0, "1,0",
                      [-2*d.rx,0].join(',')
                  ].join(' ');
                });
          },
          path: function (selection) {
            selection
                .attr("d", function (d) {
                  return line(d.points)
                })
                .attr("stroke-width", 1)
                .style("fill", "transparent")
                .style("stroke", "black");
          },
          text: function(){},
          bspline: function(){},
          polyline: function(){}
        };

        var stage = tool.generate(dot);

        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", "translate(0," + height + ") scale(1,-1)");

        var groups = svg.selectAll("g").data(stage, function (d) {
          return d.id;
        });
        groups.enter().append("g");
//        groups.exit().remove();

        var shapes = groups.selectAll(".shape").data(function (d) {
          return d.shapes;
        }, function(d,i){
          return [d.shape,i].join('-');}
        );

        shapes.enter().append("path").each(function(draw, i) {
          var shape = draw.shape;
          d3.select(this).call(drawer[shape]);
        });
//        shapes.exit().remove();

        document.body.innerHTML += "<pre>" + dump.parse(stage) + "</pre>";
      }
  );
</script>
</body>